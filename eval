import React, { useContext, useState } from 'react';
import MaterialReactTable from 'material-react-table';
import {
  Button,
  Stack,
  Snackbar,
  Alert,
  TextField,
  Dialog,
  DialogTitle,
  DialogActions,
  DialogContent,
  Typography,
} from '@mui/material';
import { ClusterContext } from '../../../NotificationContext';
import apiInstance from '../../../api';

const SlaEditor = ({ data, cluster, setSlaData }) => {
  const { userID, setSessionTimeout } = useContext(ClusterContext);
  const [tableData, setTableData] = useState(data);
  const [editedRows, setEditedRows] = useState({});
  const [openSnackbar, setOpenSnackbar] = useState(false);
  const [snackbarMessage, setSnackbarMessage] = useState('');
  const [snackbarSeverity, setSnackbarSeverity] = useState('success');
  const [openDialog, setOpenDialog] = useState(false);
  const [reason, setReason] = useState('');
  const [reasonError, setReasonError] = useState(false);
  const [openValidationDialog, setOpenValidationDialog] = useState(false);
  const [currentTotal, setCurrentTotal] = useState(0);
  const maxChars = 500;
  const formatter = new Intl.DateTimeFormat('en-GB', {
    day: '2-digit',
    month: 'short',
    year: 'numeric',
  });

  const columns = [
    { accessorKey: 'sla_name', header: 'SLA Name' },
    {
      accessorKey: 'guaranteed',
      header: 'SLA Guaranteed',
      Cell: ({ row }) => {
        const editedRow = editedRows[row.index];
        return (
          <span>
            {editedRow ? editedRow.sla_guaranteed : row.original.guaranteed}
          </span>
        );
      },
    },
    { accessorKey: 'used', header: 'SLA Used' },
    { accessorKey: 'total_used', header: 'Total Used SLA' },
    {
      accessorKey: 'sla_percent',
      header: 'SLA Percentage',
      Cell: ({ row }) => {
        const editedRow = editedRows[row.index];
        const currentValue =
          editedRow !== undefined
            ? editedRow.sla_percent
            : row.original?.sla_percent ?? '';

        const handleChange = (e) => {
          let val = e.target.value;

          if (val === '') {
            val = '0';
          }

          if (!/^\d+$/.test(val)) return;

          val = String(Number(val));

          if (Number(val) > 100) return;
          if (/^-/.test(val)) return;

          if (val === row.original.sla_percent) {
            setEditedRows((prev) => {
              const newEdits = { ...prev };
              delete newEdits[row.index];
              return newEdits;
            });
          } else {
            // recalculate SLA guaranteed
            const recalculatedGuaranteed =
              (Number(row.original.total_used) * Number(val)) / 100;

            setEditedRows((prev) => ({
              ...prev,
              [row.index]: {
                sla_name: row.original.sla_name,
                original_sla_percent: row.original.sla_percent,
                sla_percent: val,
                sla_guaranteed: recalculatedGuaranteed,
              },
            }));
          }
        };

        return (
          <TextField
            type="text"
            size="small"
            value={currentValue}
            onChange={handleChange}
            inputProps={{ inputMode: 'numeric', pattern: '[0-9]*' }}
            sx={{
              backgroundColor:
                editedRow && currentValue !== row.original.sla_percent
                  ? 'rgba(255, 245, 157, 0.5)'
                  : 'transparent',
              borderRadius: 1,
            }}
          />
        );
      },
    },
    { accessorKey: 'last_modified_by', header: 'Last Modified By' },
    {
      accessorKey: 'last_modified_at',
      header: 'Last Modified At',
      Cell: ({ cell }) => {
        const value = cell.getValue();
        const date = value ? new Date(value) : null;
        return <span>{date ? formatter.format(date) : ''}</span>;
      },
    },
    { accessorKey: 'reason', header: 'Reason' },
  ];

  const handleSave = () => {
    const payload = Object.values(editedRows).map((row) => ({
      sla_name: row.sla_name,
      old_value: row.original_sla_percent,
      new_value: row.sla_percent,
      reason,
    }));
    console.log('Payload to be sent:', payload);
    try {
      apiInstance.post('/sla_change', {
        cluster_name: cluster,
        user: userID,
        changes: payload,
      });
      setSnackbarMessage(
        'Automation triggered successfully. You will receive an email once the changes are applied.',
      );
      setSnackbarSeverity('success');
    } catch (error) {
      if (error.response && error.response.status === 401) {
        console.log('SSO Timeout');
        setSessionTimeout(true);
      }
      if (error.userResponse?.status === 500) {
        console.error('Error saving SLA changes:', error);
        setSnackbarMessage(
          'Failed to save SLA changes. Please try again.',
        );
        setSnackbarSeverity('error');
      }
    } finally {
      setOpenSnackbar(true);
      setEditedRows({});
      setOpenDialog(false);
      setReason('');
    }
  };

  const handleOpenDialog = () => {
    const updatedData = tableData.map((row, index) =>
      editedRows[index]
        ? { ...row, sla_percent: Number(editedRows[index].sla_percent) }
        : row,
    );
    const total = updatedData.reduce(
      (sum, row) => sum + Number(row.sla_percent),
      0,
    );

    if (total !== 100) {
      setCurrentTotal(total);
      setOpenValidationDialog(true);
      return;
    }
    setOpenDialog(true);
  };

  const handleCloseDialog = () => {
    setOpenDialog(false);
    setReason('');
  };

  const handleSubmit = () => {
    if (!reason.trim()) {
      setReasonError(true);
      return;
    }
    if (reason.length <= 500) {
      setReasonError(false);
      handleSave();
    } else {
      setReasonError(true);
    }
  };

  const handleCloseSnackbar = () => {
    setOpenSnackbar(false);
    setSlaData([]);
  };

  return (
    <>
      <MaterialReactTable
        columns={columns}
        data={tableData}
        muiTableBodyRowProps={({ row }) => ({
          sx: {
            backgroundColor: editedRows[row.index]
              ? 'rgba(255, 245, 157, 0.3)'
              : 'transparent',
          },
        })}
      />
      <Stack direction="row" spacing={2} sx={{ mt: 2 }}>
        <Button
          onClick={handleOpenDialog}
          disabled={Object.keys(editedRows).length === 0}
          variant="contained"
          color="primary"
        >
          Save
        </Button>

        <Button
          onClick={() => setEditedRows({})}
          variant="outlined"
          color="secondary"
        >
          Cancel
        </Button>
      </Stack>

      {/* Snackbar */}
      <Snackbar
        anchorOrigin={{ vertical: 'bottom', horizontal: 'center' }}
        open={openSnackbar}
        autoHideDuration={6000}
        onClose={handleCloseSnackbar}
        direction="up"
      >
        <Alert
          onClose={handleCloseSnackbar}
          severity={snackbarSeverity}
          variant="filled"
          sx={{ width: '100%' }}
        >
          {snackbarMessage}
        </Alert>
      </Snackbar>

      {/* Reason Dialog */}
      <Dialog open={openDialog} onClose={handleCloseDialog} fullWidth>
        <DialogTitle>Enter Reason</DialogTitle>
        <DialogContent>
          <TextField
            autoFocus
            margin="dense"
            label="Reason"
            fullWidth
            multiline
            rows={5}
            value={reason}
            onChange={(e) => {
              setReason(e.target.value);
              if (e.target.value.trim()) setReasonError(false);
            }}
            inputProps={{ maxLength: 500 }}
            error={reasonError}
            helperText={
              reasonError
                ? 'Reason is required and must be 500 characters or less.'
                : `${maxChars - reason.length} characters left`
            }
          />
        </DialogContent>
        <DialogActions>
          <Button onClick={handleCloseDialog} color="primary">
            Cancel
          </Button>
          <Button onClick={handleSubmit} color="error" variant="contained">
            Confirm
          </Button>
        </DialogActions>
      </Dialog>

      {/* Validation Dialog */}
      <Dialog
        open={openValidationDialog}
        onClose={() => setOpenValidationDialog(false)}
        fullWidth
      >
        <DialogTitle>Invalid SLA Distribution</DialogTitle>
        <DialogContent>
          <Typography>
            The total SLA distribution must equal <strong>100%</strong>. <br />
            Currently it is: <strong>{currentTotal}%</strong>.
          </Typography>
        </DialogContent>
        <DialogActions>
          <Button
            onClick={() => setOpenValidationDialog(false)}
            color="primary"
            variant="contained"
          >
            OK
          </Button>
        </DialogActions>
      </Dialog>
    </>
  );
};

export default SlaEditor;
