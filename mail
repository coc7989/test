import cx_Oracle
from flask import Flask, request, jsonify

app = Flask(__name__)

# Oracle database connection configuration
DB_USERNAME = 'your_username'
DB_PASSWORD = 'your_password'
DB_DSN = 'your_host:your_port/your_service_name'

@app.route('/update_access_end_date', methods=['POST'])
def update_access_end_date():
    try:
        # Parse JSON data from the request
        data = request.get_json()
        request_id = data.get('REQUEST_ID')
        access_end_date = data.get('ACCESS_END_DATE')

        # Validate inputs
        if not request_id or not access_end_date:
            return jsonify({'error': 'REQUEST_ID and ACCESS_END_DATE are required'}), 400

        # Connect to the Oracle database
        connection = cx_Oracle.connect(DB_USERNAME, DB_PASSWORD, DB_DSN)
        cursor = connection.cursor()

        # Define the UPDATE query
        update_query = """
            UPDATE UED_QUEUE_ACCESS
            SET ACCESS_END_DATE = TO_DATE(:access_end_date, 'YYYY-MM-DD')
            WHERE REQUEST_ID = :request_id
        """

        # Execute the query
        cursor.execute(update_query, {'access_end_date': access_end_date, 'request_id': request_id})
        
        # Commit the transaction
        connection.commit()

        # Close the cursor and connection
        cursor.close()
        connection.close()

        return jsonify({'message': 'Access End Date updated successfully'}), 200

    except cx_Oracle.DatabaseError as e:
        error, = e.args
        return jsonify({'error': f"Database error: {error.message}"}), 500
    except Exception as e:
        return jsonify({'error': str(e)}), 500


if __name__ == '__main__':
    app.run(debug=True)
