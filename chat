#!/bin/bash

vendor="$1"
mappedlicense="$2"
backupFile="$3"

while true; do
    if [ $(( $(date +%s) - $(stat -c %Y "/home/flames/data/$mappedlicense") )) -lt 120 ]; then
        lmreread=$(/home/flames/vendors/cds/pgms.linux/lmreread -c "/home/flames/data/$mappedlicense")
        reread_status=$(echo "$lmreread" | grep -o "lmreread successful")
        lmstat=$(/home/flames/vendors/cds/pgms.linux/lmstat -c "/home/flames/data/$mappedlicense")
        vendor_status=$(echo "$lmstat" | grep -o "$vendor: [^ ]*" | awk '{print $NF}')

        if [[ $reread_status == "lmreread successful" && $lmstat == "UP" ]]; then
            echo "lmreread was successful"
        else
            echo "lmreread failed or not successful"
            rsync -avz "/history/$backupFile" /.
        fi
    else
        echo 'File copy failed or timestamp is not recent'
        exit 1
    fi
    sleep 60
done
