def output = sh(
    script: """
        /opt/lmstat -C $vendor_name -f $feature_name
    """,
    returnStdout: true
).trim()

// Split the output into lines
def lines = output.split("\n")

def data = []
def total_data = [:]

lines.each { line ->
    // Check if the line contains license information
    if (line.contains("licenses issued")) {
        def serverNameMatch = line =~ /\/apps\/flames\/data\/(.*)\.lic/
        def licenseMatch = line =~ /Total of (\d+) licenses issued; Total of (\d+) licenses in use/

        if (serverNameMatch && licenseMatch) {
            def serverName = serverNameMatch[0][1]
            def licenseIssued = licenseMatch[0][1].toInteger()
            def licenseUsed = licenseMatch[0][2].toInteger()

            data << [
                server_name: serverName,
                feature_name: feature_name,
                license_issued: licenseIssued,
                license_used: licenseUsed
            ]
        }
    } else if (line.contains("Total Licenses")) {
        // Extract total data from the summary line
        def totalMatch = line =~ /Feature: (\d+) Total Licenses: (\d+) Total Used: (\d+) Total Available: (\d+)/

        if (totalMatch) {
            total_data = [
                feature_name: totalMatch[0][1],
                total_license: totalMatch[0][2].toInteger(),
                total_used: totalMatch[0][3].toInteger(),
                total_available: totalMatch[0][4].toInteger()
            ]
        }
    }
}

// Print the parsed data for debugging purposes
println "Data: ${data}"
println "Total Data: ${total_data}"

// Send data to Flask route
def response = httpRequest(
    httpMode: 'POST',
    url: 'http://your_flask_server/process_jenkins_data',
    contentType: 'APPLICATION_JSON',
    requestBody: groovy.json.JsonOutput.toJson([data: data, total_data: total_data])
)

println "Response: ${response.status}: ${response.content}"
